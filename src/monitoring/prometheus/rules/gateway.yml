groups:
  - name: gateway-alerts
    interval: 30s
    rules:
      - record: gateway:request_p95_seconds
        expr: |
          histogram_quantile(0.95, sum by (le) (rate(gateway_http_request_duration_seconds_bucket[5m])))
          or
          histogram_quantile(0.95, sum by (le) (rate(http_server_requests_seconds_bucket{job="gateway"}[5m])))

      - record: gateway:error_rate_5m
        expr: |
          (
            (sum(rate(gateway_http_requests_total{status=~"5.."}[5m])) or sum(rate(http_server_requests_seconds_count{job="gateway",status=~"5.."}[5m])) or vector(0))
            /
            clamp_min(
              (sum(rate(gateway_http_requests_total[5m])) or sum(rate(http_server_requests_seconds_count{job="gateway"}[5m])) or vector(0)),
              0.01
            )
          )

      - alert: GatewayDown
        expr: up{job="gateway"} == 0
        for: 2m
        labels:
          severity: critical
          team: gateway
        annotations:
          summary: "Gateway实例不可用"
          description: "Gateway目标抓取失败，服务可能不可达。"

      - alert: GatewayHighLatencyP95
        expr: gateway:request_p95_seconds > 1.0
        for: 10m
        labels:
          severity: warning
          team: gateway
        annotations:
          summary: "Gateway API延迟过高"
          description: "P95请求延迟超过1秒并持续10分钟。"

      - alert: GatewayErrorRateHigh
        expr: gateway:error_rate_5m > 0.05
        for: 10m
        labels:
          severity: critical
          team: gateway
        annotations:
          summary: "Gateway错误率过高"
          description: "5xx错误率超过5%，请检查上游依赖和应用日志。"
